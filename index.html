<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>推理问卷标注系统</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      margin: 0;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }

    h1, h2, h3 {
      color: #222;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    select, input, textarea {
      font-size: 16px;
      padding: 6px;
      width: 100%;
      margin-top: 4px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    textarea {
      resize: vertical;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 12px;
    }

    button:hover {
      background: #0056b3;
    }

    .hidden {
      display: none;
    }

    .question-card {
      background: #f0f4f8;
      padding: 16px;
      border-left: 4px solid #007bff;
      margin-bottom: 16px;
      border-radius: 6px;
    }

    .context-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<>
  <div class="container">

  <h1>推理问卷标注系统</h1>

  <!-- Step 1: 说明区域 -->
  <div id="instructions">
    <h3>说明：</h3>
    <ol>
      <li><strong>问题</strong>：认真阅读题目，仔细思考所给选项，从中选择正确的答案。</li>
      <li><strong>推理过程</strong>：从你最初认为可能正确的答案开始解释。思考为什么某些选项可能正确，为什么其他可能不正确。
        <ul>
          <li>描述你的思考过程——不要跳过任何步骤，即使某些步骤看起来微不足道。</li>
          <li>如果你做出了某个假设或猜测，请解释你为什么会那样想。</li>
          <li>如果你改变了想法或放弃了某个选项，请说明原因。</li>
        </ul>
      </li>
      <li><strong>最终答案</strong>：在完成整个思考过程后，选择你认为正确的选项，并解释你为什么选择它。如果你不确定，也请说明你的不确定性。</li>
    </ol>
    <h4>好的回答示例：</h4>
    <pre>
问题：“回声是由哪种类型的声音反射产生的？”
A：直接的（Direct）
B：远处的（Distant）
C：变化的（Varied）
D：单一的（Single）

“这个问题是关于哪种反射类型会产生回声…所以答案很明确，我应该选择 A。”
    </pre>
    <button onclick="showUserInfo()">我已阅读说明，开始填写</button>
    <button onclick="clearCache()">🧹 清除缓存数据</button>
  </div>

  <!-- Step 2: 用户信息 -->
  <div id="user-info" class="hidden">
    <label>性别：
      <select id="gender">
        <option value="">请选择</option>
        <option value="男">男</option>
        <option value="女">女</option>
        <option value="其他">其他</option>
      </select>
    </label>
    <label>学校：<input type="text" id="school"></label>
    <label>学历：
      <select id="degree">
        <option value="">请选择</option>
        <option value="本科">本科</option>
        <option value="硕士">硕士</option>
        <option value="博士">博士</option>
        <option value="其他">其他</option>
      </select>
    </label>
    <label>省/直辖市：<input type="text" id="region"></label>
    <button onclick="showTipi()">填写大五人格测试</button>
  </div>

  <!-- Step 2.5: TIPI 测试 -->
  <div id="tipi-test" class="hidden">
    <h3>TIPI 大五人格测试</h3>
    <p>请根据你自己的感觉，选择每一对形容词在你身上的适用程度（1=非常不同意，7=非常同意）</p>
    <div id="tipi-items"></div>
    <button onclick="confirmTipi()">确认提交 TIPI 测试</button>
  </div>

  <!-- Step 3: 选择题目组 -->
  <div id="group-select-section" class="hidden">
    <label>请选择题目组（每组包含不同的题目组合）：</label>
    <select id="group-select">
      <option value="">请选择</option>
      <option value="group_1">第1组</option>
      <option value="group_2">第2组</option>
      <option value="group_3">第3组</option>
      <option value="group_4">第4组</option>
      <option value="group_5">第5组</option>
      <option value="group_6">第6组</option>
      <option value="group_7">第7组</option>
      <option value="group_8">第8组</option>
      <option value="group_9">第9组</option>
      <option value="group_10">第10组</option>
    </select>
    <button onclick="startGroup()">开始标注</button>
  </div>

  <!-- Step 4: 选择推理类型 -->
  <div id="category-select-section" class="hidden">
    <label>选择推理类型：</label>
    <select id="category-select">
      <option value="">请选择</option>
      <option value="abduction">Abduction（溯因）</option>
      <option value="deduction">Deduction（演绎）</option>
      <option value="induction">Induction（归纳）</option>
    </select>
    <button onclick="startCategory()">开始标注</button>
  </div>

  <!-- Step 5: 标注界面 -->
  <div id="questionnaire" class="hidden">
    <div id="question-box"></div>

    <label>你是否该题目专业方向？</label>
    <select id="is-expert">
      <option value="">请选择</option>
      <option value="是">是</option>
      <option value="否">否</option>
    </select>

    <label>是否使用 AI 辅助？</label>
    <select id="use-ai">
      <option value="">请选择</option>
      <option value="是">是</option>
      <option value="否">否</option>
    </select>

    <label>是否检索了相关知识？</label>
    <select id="did-search">
      <option value="">请选择</option>
      <option value="是">是</option>
      <option value="否">否</option>
    </select>

    <label>推理过程：</label>
    <div id="reasoning-steps-container"></div>
    <button type="button" onclick="addReasoningStep()">➕ 新增步骤</button>

    <label>最终答案：</label>
    <div id="final-answer"></div>


    <br/>
    <button onclick="goBack()">⬅️ 返回上一题</button>
    <button onclick="saveAndNext()">保存并进入下一题</button>
    <button onclick="downloadResults()">📤 下载已标注数据</button>
    <button onclick="switchGroup()">🔁 切换题目组</button>
  </div>

  <!-- 完成提示 -->
  <div id="done" class="hidden">
    <h2>本组题目已标注完成 🎉</h2>
    <button onclick="reset()">切换题目组</button>
  </div>

  <script>
    // Firebase 初始化
    const firebaseConfig = {
      apiKey: "AIzaSyBEY2NQRQoOYupja0VAT-ybcIVn7nDtitk",
      authDomain: "reasoning-survey.firebaseapp.com",
      databaseURL: "https://reasoning-survey-default-rtdb.firebaseio.com",
      projectId: "reasoning-survey",
      storageBucket: "reasoning-survey.appspot.com",
      messagingSenderId: "307395227633",
      appId: "1:307395227633:web:e79e929d0b7bb3e0b8de50"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 全局状态
    let userInfo = {},
        questions = [],
        questionIndex = 0,
        completedMap = {},
        responses = [],
        currentCategory = "";

    const tipiItems = [
      { id:1, text:"我属于外向型、爱交际" },
      { id:2, text:"我属于冷静型、安静" },
      { id:3, text:"我喜欢有条理、做事计划性强" },
      { id:4, text:"我有些懒惰" },
      { id:5, text:"我容易紧张" },
      { id:6, text:"我情绪稳定，不易心烦" },
      { id:7, text:"我是有创造力、有想象力的人" },
      { id:8, text:"我是传统型、不会尝试新奇事物" },
      { id:9, text:"我考虑周到、关心他人" },
      { id:10,text:"我有时很苛刻" }
    ];

    // UI 流程
    function showUserInfo() {
      document.getElementById("instructions").classList.add("hidden");
      document.getElementById("user-info").classList.remove("hidden");
    }
    function showTipi() {
      const g = document.getElementById("gender").value.trim();
      const s = document.getElementById("school").value.trim();
      const d = document.getElementById("degree").value.trim();
      const r = document.getElementById("region").value.trim();
      if (!g || !s || !d || !r) {
        return alert("请完整填写用户信息");
      }
      userInfo = { gender: g, school: s, degree: d, region: r };
      document.getElementById("user-info").classList.add("hidden");
      document.getElementById("tipi-test").classList.remove("hidden");
      const ctr = document.getElementById("tipi-items");
      ctr.innerHTML = "";
      tipiItems.forEach(({id,text})=>{
        const div = document.createElement("div");
        div.innerHTML = `
          <label>${id}. ${text}</label>
          <select id="tipi-${id}">
            ${[...Array(7)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}
          </select>`;
        ctr.appendChild(div);
      });
    }
    function confirmTipi() {
      const scores = {};
      tipiItems.forEach(({id})=>{
        scores[`item${id}`] = +document.getElementById(`tipi-${id}`).value;
      });
      userInfo.tipi_scores = scores;
      localStorage.setItem("user_info", JSON.stringify(userInfo));
      document.getElementById("tipi-test").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    async function startGroup() {
      const grp = document.getElementById("group-select").value;
      if (!grp) return alert("请选择题目组");
      currentCategory = grp;
      loadCompleted();
      try {
        const text = await (await fetch(`10_groups_output/${grp}.jsonl`)).text();
        questions = text.trim().split("\n").map(l=>JSON.parse(l));
      } catch(e) {
        return alert("加载失败："+e);
      }
      if (!questions.length) {
        document.getElementById("done").classList.remove("hidden");
        return;
      }
      questionIndex = 0;
      responses = [];
      document.getElementById("group-select-section").classList.add("hidden");
      document.getElementById("done").classList.add("hidden");
      document.getElementById("questionnaire").classList.remove("hidden");
      showQuestion();
    }

    function startCategory() {
      // 如果你还需要根据推理类型再过滤题目，在这里实现
      document.getElementById("category-select-section").classList.add("hidden");
      document.getElementById("questionnaire").classList.remove("hidden");
    }

    function showQuestion() {
      const q = questions[questionIndex];
      let html = `
        <div class="question-card">
          <h3 style="margin-bottom: 10px;">题目 ${questionIndex + 1} / ${questions.length}</h3>
      `;

      if (q.context) {
        html += `
          <div class="context-box">
            <strong>上下文：</strong><br>${q.context}
          </div>
        `;
      }

      html += `<div style="margin: 10px 0;"><strong>${q.question}</strong></div>`;

      (q.choices || []).forEach(c => {
        const m = c.match(/^\((.)\)\s*(.*)$/);
        if (m) {
          html += `<div style="padding-left: 8px;">${m[1]}：${m[2]}</div>`;
        }
      });

      html += `</div>`;
      document.getElementById("question-box").innerHTML = html;
      renderFinalAnswerOptions(q.choices);
      initReasoningSteps();
      ["is-expert","use-ai","did-search"].forEach(id=>{
        document.getElementById(id).value="";
      });
    }

    function renderFinalAnswerOptions(choices) {
      const container = document.getElementById("final-answer");
      container.innerHTML = "";
      if (Array.isArray(choices) && choices.length > 0) {
        const sel = document.createElement("select");
        sel.id = "final-answer-select";
        sel.innerHTML = `<option value="">请选择</option>`;
        for (const c of choices) {
          const m = c.match(/^\((.)\)\s*(.*)$/);
          if (m) sel.innerHTML += `<option value="${m[1]}">${m[1]}: ${m[2]}</option>`;
        }
        sel.innerHTML += `<option value="不确定">不确定</option>`;
        container.appendChild(sel);
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.id = "final-answer-text";
        input.placeholder = "请输入你的最终答案（非选择题）";
        container.appendChild(input);
      }
    }

    function saveAndNext() {
      const steps = collectSteps();
      const sel = document.getElementById("final-answer-select");
      const txt = document.getElementById("final-answer-text");
      const ans = sel ? sel.value : (txt ? txt.value.trim() : "");
      const exp = document.getElementById("is-expert").value;
      const ai = document.getElementById("use-ai").value;
      const ds = document.getElementById("did-search").value;
      if (!exp||!ai||!ds||!ans||!steps.length) {
        return alert("请完整填写所有字段");
      }
      const q = questions[questionIndex];
      const entry = {
        user_info: userInfo,
        id: q.id || q.index || `question_${Date.now()}`,  // 增加容错
        source_group: currentCategory,
        question: q.question,
        options: q.choices,
        user_is_expert: exp,
        used_ai: ai,
        did_search: ds,
        reasoning_steps: steps,
        final_answer: ans
      };
      responses = responses.filter(r=>r.id!==q.id).concat(entry);
      markDone(q.id);
      saveLocal(entry);
      saveToFirebase(entry);
      questionIndex++;
      if (questionIndex>=questions.length) {
        document.getElementById("questionnaire").classList.add("hidden");
        document.getElementById("done").classList.remove("hidden");
      } else {
        showQuestion();
      }
    }


    function goBack() {
      if (questionIndex===0) return alert("已经是第一题");
      questionIndex--;
      showQuestion();
    }

    function switchGroup() {
      if (!confirm("确定切换题目组？")) return;
      document.getElementById("questionnaire").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    function reset() {
      document.getElementById("done").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    // 辅助：推理步骤
    function initReasoningSteps() {
      const ctr = document.getElementById("reasoning-steps-container");
      ctr.innerHTML = "";
      addReasoningStep();
    }
    function addReasoningStep(txt="") {
      const ctr = document.getElementById("reasoning-steps-container");
      const idx = ctr.children.length + 1;
      const div = document.createElement("div");
      div.innerHTML = `
        <label>推理步骤 ${idx}</label>
        <textarea>${txt}</textarea>
        <button type="button" onclick="this.parentNode.remove(),initReasoningSteps()">删除该步骤</button>
      `;
      ctr.appendChild(div);
    }
    function collectSteps() {
      return Array.from(document.querySelectorAll("#reasoning-steps-container textarea"))
        .map(t=>t.value.trim()).filter(v=>v);
    }

    // 本地存储
    function loadCompleted() {
      completedMap = JSON.parse(localStorage.getItem("completed_ids")||"{}");
    }
    function markDone(id) {
      completedMap[`${currentCategory}:${id}`] = true;
      localStorage.setItem("completed_ids", JSON.stringify(completedMap));
    }
    function saveLocal(entry) {
      const arr = JSON.parse(localStorage.getItem("responses")||"[]");
      arr.push(entry);
      localStorage.setItem("responses", JSON.stringify(arr));
    }

    // Firebase 存储
    function saveToFirebase(entry) {
      database.ref("responses/" + Date.now()).set(entry)
        .catch(console.error);
    }

    // 下载
    function downloadResults() {
      const data = localStorage.getItem("responses");
      if (!data) return alert("无标注结果");
      const u = JSON.parse(localStorage.getItem("user_info")||"{}");
      const fn = `annotated_${u.gender||"u"}_${u.school||"u"}_${u.degree||"u"}_${u.region||"u"}_${new Date().toISOString().slice(0,10)}.json`;
      const b = new Blob([data], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download = fn;
      a.click();
    }

    function clearCache() {
      if (confirm("⚠️ 确定清除所有缓存？")) {
        localStorage.clear();
        location.reload();
      }
    }

    window.onload = () => {
      const u = localStorage.getItem("user_info");
      if (u) userInfo = JSON.parse(u);
    };
  </script>
  </div>

</body>
</html>
