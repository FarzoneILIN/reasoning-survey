<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ¨ç†é—®å·æ ‡æ³¨ç³»ç»Ÿ</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      margin: 0;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }

    h1, h2, h3 {
      color: #222;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    select, input, textarea {
      font-size: 16px;
      padding: 6px;
      width: 100%;
      margin-top: 4px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    textarea {
      resize: vertical;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 12px;
    }

    button:hover {
      background: #0056b3;
    }

    .hidden {
      display: none;
    }

    .question-card {
      background: #f0f4f8;
      padding: 16px;
      border-left: 4px solid #007bff;
      margin-bottom: 16px;
      border-radius: 6px;
    }

    .context-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<>
  <div class="container">

  <h1>æ¨ç†é—®å·æ ‡æ³¨ç³»ç»Ÿ</h1>

  <!-- Step 1: è¯´æ˜åŒºåŸŸ -->
  <div id="instructions">
    <h3>è¯´æ˜ï¼š</h3>
    <ol>
      <li><strong>é—®é¢˜</strong>ï¼šè®¤çœŸé˜…è¯»é¢˜ç›®ï¼Œä»”ç»†æ€è€ƒæ‰€ç»™é€‰é¡¹ï¼Œä»ä¸­é€‰æ‹©æ­£ç¡®çš„ç­”æ¡ˆã€‚</li>
      <li><strong>æ¨ç†è¿‡ç¨‹</strong>ï¼šä»ä½ æœ€åˆè®¤ä¸ºå¯èƒ½æ­£ç¡®çš„ç­”æ¡ˆå¼€å§‹è§£é‡Šã€‚æ€è€ƒä¸ºä»€ä¹ˆæŸäº›é€‰é¡¹å¯èƒ½æ­£ç¡®ï¼Œä¸ºä»€ä¹ˆå…¶ä»–å¯èƒ½ä¸æ­£ç¡®ã€‚
        <ul>
          <li>æè¿°ä½ çš„æ€è€ƒè¿‡ç¨‹â€”â€”ä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ï¼Œå³ä½¿æŸäº›æ­¥éª¤çœ‹èµ·æ¥å¾®ä¸è¶³é“ã€‚</li>
          <li>å¦‚æœä½ åšå‡ºäº†æŸä¸ªå‡è®¾æˆ–çŒœæµ‹ï¼Œè¯·è§£é‡Šä½ ä¸ºä»€ä¹ˆä¼šé‚£æ ·æƒ³ã€‚</li>
          <li>å¦‚æœä½ æ”¹å˜äº†æƒ³æ³•æˆ–æ”¾å¼ƒäº†æŸä¸ªé€‰é¡¹ï¼Œè¯·è¯´æ˜åŸå› ã€‚</li>
        </ul>
      </li>
      <li><strong>æœ€ç»ˆç­”æ¡ˆ</strong>ï¼šåœ¨å®Œæˆæ•´ä¸ªæ€è€ƒè¿‡ç¨‹åï¼Œé€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„é€‰é¡¹ï¼Œå¹¶è§£é‡Šä½ ä¸ºä»€ä¹ˆé€‰æ‹©å®ƒã€‚å¦‚æœä½ ä¸ç¡®å®šï¼Œä¹Ÿè¯·è¯´æ˜ä½ çš„ä¸ç¡®å®šæ€§ã€‚</li>
    </ol>
    <h4>å¥½çš„å›ç­”ç¤ºä¾‹ï¼š</h4>
    <pre>
é—®é¢˜ï¼šâ€œå›å£°æ˜¯ç”±å“ªç§ç±»å‹çš„å£°éŸ³åå°„äº§ç”Ÿçš„ï¼Ÿâ€
Aï¼šç›´æ¥çš„ï¼ˆDirectï¼‰
Bï¼šè¿œå¤„çš„ï¼ˆDistantï¼‰
Cï¼šå˜åŒ–çš„ï¼ˆVariedï¼‰
Dï¼šå•ä¸€çš„ï¼ˆSingleï¼‰

â€œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºå“ªç§åå°„ç±»å‹ä¼šäº§ç”Ÿå›å£°â€¦æ‰€ä»¥ç­”æ¡ˆå¾ˆæ˜ç¡®ï¼Œæˆ‘åº”è¯¥é€‰æ‹© Aã€‚â€
    </pre>
    <button onclick="showUserInfo()">æˆ‘å·²é˜…è¯»è¯´æ˜ï¼Œå¼€å§‹å¡«å†™</button>
    <button onclick="clearCache()">ğŸ§¹ æ¸…é™¤ç¼“å­˜æ•°æ®</button>
  </div>

  <!-- Step 2: ç”¨æˆ·ä¿¡æ¯ -->
  <div id="user-info" class="hidden">
    <label>æ€§åˆ«ï¼š
      <select id="gender">
        <option value="">è¯·é€‰æ‹©</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </label>
    <label>å­¦æ ¡ï¼š<input type="text" id="school"></label>
    <label>å­¦å†ï¼š
      <select id="degree">
        <option value="">è¯·é€‰æ‹©</option>
        <option value="æœ¬ç§‘">æœ¬ç§‘</option>
        <option value="ç¡•å£«">ç¡•å£«</option>
        <option value="åšå£«">åšå£«</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </label>
    <label>çœ/ç›´è¾–å¸‚ï¼š<input type="text" id="region"></label>
    <button onclick="showTipi()">å¡«å†™å¤§äº”äººæ ¼æµ‹è¯•</button>
  </div>

  <!-- Step 2.5: TIPI æµ‹è¯• -->
  <div id="tipi-test" class="hidden">
    <h3>TIPI å¤§äº”äººæ ¼æµ‹è¯•</h3>
    <p>è¯·æ ¹æ®ä½ è‡ªå·±çš„æ„Ÿè§‰ï¼Œé€‰æ‹©æ¯ä¸€å¯¹å½¢å®¹è¯åœ¨ä½ èº«ä¸Šçš„é€‚ç”¨ç¨‹åº¦ï¼ˆ1=éå¸¸ä¸åŒæ„ï¼Œ7=éå¸¸åŒæ„ï¼‰</p>
    <div id="tipi-items"></div>
    <button onclick="confirmTipi()">ç¡®è®¤æäº¤ TIPI æµ‹è¯•</button>
  </div>

  <!-- Step 3: é€‰æ‹©é¢˜ç›®ç»„ -->
  <div id="group-select-section" class="hidden">
    <label>è¯·é€‰æ‹©é¢˜ç›®ç»„ï¼ˆæ¯ç»„åŒ…å«ä¸åŒçš„é¢˜ç›®ç»„åˆï¼‰ï¼š</label>
    <select id="group-select">
      <option value="">è¯·é€‰æ‹©</option>
      <option value="group_1">ç¬¬1ç»„</option>
      <option value="group_2">ç¬¬2ç»„</option>
      <option value="group_3">ç¬¬3ç»„</option>
      <option value="group_4">ç¬¬4ç»„</option>
      <option value="group_5">ç¬¬5ç»„</option>
      <option value="group_6">ç¬¬6ç»„</option>
      <option value="group_7">ç¬¬7ç»„</option>
      <option value="group_8">ç¬¬8ç»„</option>
      <option value="group_9">ç¬¬9ç»„</option>
      <option value="group_10">ç¬¬10ç»„</option>
    </select>
    <button onclick="startGroup()">å¼€å§‹æ ‡æ³¨</button>
  </div>

  <!-- Step 4: é€‰æ‹©æ¨ç†ç±»å‹ -->
  <div id="category-select-section" class="hidden">
    <label>é€‰æ‹©æ¨ç†ç±»å‹ï¼š</label>
    <select id="category-select">
      <option value="">è¯·é€‰æ‹©</option>
      <option value="abduction">Abductionï¼ˆæº¯å› ï¼‰</option>
      <option value="deduction">Deductionï¼ˆæ¼”ç»ï¼‰</option>
      <option value="induction">Inductionï¼ˆå½’çº³ï¼‰</option>
    </select>
    <button onclick="startCategory()">å¼€å§‹æ ‡æ³¨</button>
  </div>

  <!-- Step 5: æ ‡æ³¨ç•Œé¢ -->
  <div id="questionnaire" class="hidden">
    <div id="question-box"></div>

    <label>ä½ æ˜¯å¦è¯¥é¢˜ç›®ä¸“ä¸šæ–¹å‘ï¼Ÿ</label>
    <select id="is-expert">
      <option value="">è¯·é€‰æ‹©</option>
      <option value="æ˜¯">æ˜¯</option>
      <option value="å¦">å¦</option>
    </select>

    <label>æ˜¯å¦ä½¿ç”¨ AI è¾…åŠ©ï¼Ÿ</label>
    <select id="use-ai">
      <option value="">è¯·é€‰æ‹©</option>
      <option value="æ˜¯">æ˜¯</option>
      <option value="å¦">å¦</option>
    </select>

    <label>æ˜¯å¦æ£€ç´¢äº†ç›¸å…³çŸ¥è¯†ï¼Ÿ</label>
    <select id="did-search">
      <option value="">è¯·é€‰æ‹©</option>
      <option value="æ˜¯">æ˜¯</option>
      <option value="å¦">å¦</option>
    </select>

    <label>æ¨ç†è¿‡ç¨‹ï¼š</label>
    <div id="reasoning-steps-container"></div>
    <button type="button" onclick="addReasoningStep()">â• æ–°å¢æ­¥éª¤</button>

    <label>æœ€ç»ˆç­”æ¡ˆï¼š</label>
    <div id="final-answer"></div>


    <br/>
    <button onclick="goBack()">â¬…ï¸ è¿”å›ä¸Šä¸€é¢˜</button>
    <button onclick="saveAndNext()">ä¿å­˜å¹¶è¿›å…¥ä¸‹ä¸€é¢˜</button>
    <button onclick="downloadResults()">ğŸ“¤ ä¸‹è½½å·²æ ‡æ³¨æ•°æ®</button>
    <button onclick="switchGroup()">ğŸ” åˆ‡æ¢é¢˜ç›®ç»„</button>
  </div>

  <!-- å®Œæˆæç¤º -->
  <div id="done" class="hidden">
    <h2>æœ¬ç»„é¢˜ç›®å·²æ ‡æ³¨å®Œæˆ ğŸ‰</h2>
    <button onclick="reset()">åˆ‡æ¢é¢˜ç›®ç»„</button>
  </div>

  <script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyBEY2NQRQoOYupja0VAT-ybcIVn7nDtitk",
      authDomain: "reasoning-survey.firebaseapp.com",
      databaseURL: "https://reasoning-survey-default-rtdb.firebaseio.com",
      projectId: "reasoning-survey",
      storageBucket: "reasoning-survey.appspot.com",
      messagingSenderId: "307395227633",
      appId: "1:307395227633:web:e79e929d0b7bb3e0b8de50"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // å…¨å±€çŠ¶æ€
    let userInfo = {},
        questions = [],
        questionIndex = 0,
        completedMap = {},
        responses = [],
        currentCategory = "";

    const tipiItems = [
      { id:1, text:"æˆ‘å±äºå¤–å‘å‹ã€çˆ±äº¤é™…" },
      { id:2, text:"æˆ‘å±äºå†·é™å‹ã€å®‰é™" },
      { id:3, text:"æˆ‘å–œæ¬¢æœ‰æ¡ç†ã€åšäº‹è®¡åˆ’æ€§å¼º" },
      { id:4, text:"æˆ‘æœ‰äº›æ‡’æƒ°" },
      { id:5, text:"æˆ‘å®¹æ˜“ç´§å¼ " },
      { id:6, text:"æˆ‘æƒ…ç»ªç¨³å®šï¼Œä¸æ˜“å¿ƒçƒ¦" },
      { id:7, text:"æˆ‘æ˜¯æœ‰åˆ›é€ åŠ›ã€æœ‰æƒ³è±¡åŠ›çš„äºº" },
      { id:8, text:"æˆ‘æ˜¯ä¼ ç»Ÿå‹ã€ä¸ä¼šå°è¯•æ–°å¥‡äº‹ç‰©" },
      { id:9, text:"æˆ‘è€ƒè™‘å‘¨åˆ°ã€å…³å¿ƒä»–äºº" },
      { id:10,text:"æˆ‘æœ‰æ—¶å¾ˆè‹›åˆ»" }
    ];

    // UI æµç¨‹
    function showUserInfo() {
      document.getElementById("instructions").classList.add("hidden");
      document.getElementById("user-info").classList.remove("hidden");
    }
    function showTipi() {
      const g = document.getElementById("gender").value.trim();
      const s = document.getElementById("school").value.trim();
      const d = document.getElementById("degree").value.trim();
      const r = document.getElementById("region").value.trim();
      if (!g || !s || !d || !r) {
        return alert("è¯·å®Œæ•´å¡«å†™ç”¨æˆ·ä¿¡æ¯");
      }
      userInfo = { gender: g, school: s, degree: d, region: r };
      document.getElementById("user-info").classList.add("hidden");
      document.getElementById("tipi-test").classList.remove("hidden");
      const ctr = document.getElementById("tipi-items");
      ctr.innerHTML = "";
      tipiItems.forEach(({id,text})=>{
        const div = document.createElement("div");
        div.innerHTML = `
          <label>${id}. ${text}</label>
          <select id="tipi-${id}">
            ${[...Array(7)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}
          </select>`;
        ctr.appendChild(div);
      });
    }
    function confirmTipi() {
      const scores = {};
      tipiItems.forEach(({id})=>{
        scores[`item${id}`] = +document.getElementById(`tipi-${id}`).value;
      });
      userInfo.tipi_scores = scores;
      localStorage.setItem("user_info", JSON.stringify(userInfo));
      document.getElementById("tipi-test").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    async function startGroup() {
      const grp = document.getElementById("group-select").value;
      if (!grp) return alert("è¯·é€‰æ‹©é¢˜ç›®ç»„");
      currentCategory = grp;
      loadCompleted();
      try {
        const text = await (await fetch(`10_groups_output/${grp}.jsonl`)).text();
        questions = text.trim().split("\n").map(l=>JSON.parse(l));
      } catch(e) {
        return alert("åŠ è½½å¤±è´¥ï¼š"+e);
      }
      if (!questions.length) {
        document.getElementById("done").classList.remove("hidden");
        return;
      }
      questionIndex = 0;
      responses = [];
      document.getElementById("group-select-section").classList.add("hidden");
      document.getElementById("done").classList.add("hidden");
      document.getElementById("questionnaire").classList.remove("hidden");
      showQuestion();
    }

    function startCategory() {
      // å¦‚æœä½ è¿˜éœ€è¦æ ¹æ®æ¨ç†ç±»å‹å†è¿‡æ»¤é¢˜ç›®ï¼Œåœ¨è¿™é‡Œå®ç°
      document.getElementById("category-select-section").classList.add("hidden");
      document.getElementById("questionnaire").classList.remove("hidden");
    }

    function showQuestion() {
      const q = questions[questionIndex];
      let html = `
        <div class="question-card">
          <h3 style="margin-bottom: 10px;">é¢˜ç›® ${questionIndex + 1} / ${questions.length}</h3>
      `;

      if (q.context) {
        html += `
          <div class="context-box">
            <strong>ä¸Šä¸‹æ–‡ï¼š</strong><br>${q.context}
          </div>
        `;
      }

      html += `<div style="margin: 10px 0;"><strong>${q.question}</strong></div>`;

      (q.choices || []).forEach(c => {
        const m = c.match(/^\((.)\)\s*(.*)$/);
        if (m) {
          html += `<div style="padding-left: 8px;">${m[1]}ï¼š${m[2]}</div>`;
        }
      });

      html += `</div>`;
      document.getElementById("question-box").innerHTML = html;
      renderFinalAnswerOptions(q.choices);
      initReasoningSteps();
      ["is-expert","use-ai","did-search"].forEach(id=>{
        document.getElementById(id).value="";
      });
    }

    function renderFinalAnswerOptions(choices) {
      const container = document.getElementById("final-answer");
      container.innerHTML = "";
      if (Array.isArray(choices) && choices.length > 0) {
        const sel = document.createElement("select");
        sel.id = "final-answer-select";
        sel.innerHTML = `<option value="">è¯·é€‰æ‹©</option>`;
        for (const c of choices) {
          const m = c.match(/^\((.)\)\s*(.*)$/);
          if (m) sel.innerHTML += `<option value="${m[1]}">${m[1]}: ${m[2]}</option>`;
        }
        sel.innerHTML += `<option value="ä¸ç¡®å®š">ä¸ç¡®å®š</option>`;
        container.appendChild(sel);
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.id = "final-answer-text";
        input.placeholder = "è¯·è¾“å…¥ä½ çš„æœ€ç»ˆç­”æ¡ˆï¼ˆéé€‰æ‹©é¢˜ï¼‰";
        container.appendChild(input);
      }
    }

    function saveAndNext() {
      const steps = collectSteps();
      const sel = document.getElementById("final-answer-select");
      const txt = document.getElementById("final-answer-text");
      const ans = sel ? sel.value : (txt ? txt.value.trim() : "");
      const exp = document.getElementById("is-expert").value;
      const ai = document.getElementById("use-ai").value;
      const ds = document.getElementById("did-search").value;
      if (!exp||!ai||!ds||!ans||!steps.length) {
        return alert("è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å­—æ®µ");
      }
      const q = questions[questionIndex];
      const entry = {
        user_info: userInfo,
        id: q.id || q.index || `question_${Date.now()}`,  // å¢åŠ å®¹é”™
        source_group: currentCategory,
        question: q.question,
        options: q.choices,
        user_is_expert: exp,
        used_ai: ai,
        did_search: ds,
        reasoning_steps: steps,
        final_answer: ans
      };
      responses = responses.filter(r=>r.id!==q.id).concat(entry);
      markDone(q.id);
      saveLocal(entry);
      saveToFirebase(entry);
      questionIndex++;
      if (questionIndex>=questions.length) {
        document.getElementById("questionnaire").classList.add("hidden");
        document.getElementById("done").classList.remove("hidden");
      } else {
        showQuestion();
      }
    }


    function goBack() {
      if (questionIndex===0) return alert("å·²ç»æ˜¯ç¬¬ä¸€é¢˜");
      questionIndex--;
      showQuestion();
    }

    function switchGroup() {
      if (!confirm("ç¡®å®šåˆ‡æ¢é¢˜ç›®ç»„ï¼Ÿ")) return;
      document.getElementById("questionnaire").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    function reset() {
      document.getElementById("done").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    // è¾…åŠ©ï¼šæ¨ç†æ­¥éª¤
    function initReasoningSteps() {
      const ctr = document.getElementById("reasoning-steps-container");
      ctr.innerHTML = "";
      addReasoningStep();
    }
    function addReasoningStep(txt="") {
      const ctr = document.getElementById("reasoning-steps-container");
      const idx = ctr.children.length + 1;
      const div = document.createElement("div");
      div.innerHTML = `
        <label>æ¨ç†æ­¥éª¤ ${idx}</label>
        <textarea>${txt}</textarea>
        <button type="button" onclick="this.parentNode.remove(),initReasoningSteps()">åˆ é™¤è¯¥æ­¥éª¤</button>
      `;
      ctr.appendChild(div);
    }
    function collectSteps() {
      return Array.from(document.querySelectorAll("#reasoning-steps-container textarea"))
        .map(t=>t.value.trim()).filter(v=>v);
    }

    // æœ¬åœ°å­˜å‚¨
    function loadCompleted() {
      completedMap = JSON.parse(localStorage.getItem("completed_ids")||"{}");
    }
    function markDone(id) {
      completedMap[`${currentCategory}:${id}`] = true;
      localStorage.setItem("completed_ids", JSON.stringify(completedMap));
    }
    function saveLocal(entry) {
      const arr = JSON.parse(localStorage.getItem("responses")||"[]");
      arr.push(entry);
      localStorage.setItem("responses", JSON.stringify(arr));
    }

    // Firebase å­˜å‚¨
    function saveToFirebase(entry) {
      database.ref("responses/" + Date.now()).set(entry)
        .catch(console.error);
    }

    // ä¸‹è½½
    function downloadResults() {
      const data = localStorage.getItem("responses");
      if (!data) return alert("æ— æ ‡æ³¨ç»“æœ");
      const u = JSON.parse(localStorage.getItem("user_info")||"{}");
      const fn = `annotated_${u.gender||"u"}_${u.school||"u"}_${u.degree||"u"}_${u.region||"u"}_${new Date().toISOString().slice(0,10)}.json`;
      const b = new Blob([data], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download = fn;
      a.click();
    }

    function clearCache() {
      if (confirm("âš ï¸ ç¡®å®šæ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼Ÿ")) {
        localStorage.clear();
        location.reload();
      }
    }

    window.onload = () => {
      const u = localStorage.getItem("user_info");
      if (u) userInfo = JSON.parse(u);
    };
  </script>
  </div>

</body>
</html>
