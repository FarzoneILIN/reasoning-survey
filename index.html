<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ¨ç†é—®å·æ ‡æ³¨ç³»ç»Ÿ</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      margin: 0;
      color: #333;
    }
    pre {
  white-space: pre-wrap;  /* è®©é•¿è¡Œåœ¨è¾¹ç•Œè‡ªåŠ¨æ¢è¡Œ */
  word-break: break-word; /* å¦‚æœæœ‰è¶…é•¿å•è¯æˆ–æ— ç©ºæ ¼é•¿ä¸²æ—¶ï¼Œå¼ºåˆ¶æ–­å¼€ */
    }

    ol {
      word-break: break-word; 
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }

    h1, h2, h3 {
      color: #222;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    select, input, textarea {
      font-size: 16px;
      padding: 6px;
      width: 100%;
      margin-top: 4px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    textarea {
      resize: vertical;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 12px;
    }

    button:hover {
      background: #0056b3;
    }

    .hidden {
      display: none;
    }

    .question-card {
      background: #f0f4f8;
      padding: 16px;
      border-left: 4px solid #007bff;
      margin-bottom: 16px;
      border-radius: 6px;
    }

    .context-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<>
  <div class="container">
  <div style="text-align: right;">
    <button onclick="switchLanguage()">
      <span id="lang-btn-text">English</span>
    </button>
  </div>

  <h1 id="main-title"></h1>

  <!-- Step 1: è¯´æ˜åŒºåŸŸ -->
  <div id="instructions">
    <h3 id="instructions-title"></h3>
    <ol>
      <li><strong>é—®é¢˜</strong>ï¼šè®¤çœŸé˜…è¯»é¢˜ç›®ï¼Œä»”ç»†æ€è€ƒæ‰€ç»™é€‰é¡¹ï¼Œä»ä¸­é€‰æ‹©æ­£ç¡®çš„ç­”æ¡ˆã€‚</li>
      <li><strong>æ¨ç†è¿‡ç¨‹</strong>ï¼šä»ä½ æœ€åˆè®¤ä¸ºå¯èƒ½æ­£ç¡®çš„ç­”æ¡ˆå¼€å§‹è§£é‡Šã€‚æ€è€ƒä¸ºä»€ä¹ˆæŸäº›é€‰é¡¹å¯èƒ½æ­£ç¡®ï¼Œä¸ºä»€ä¹ˆå…¶ä»–å¯èƒ½ä¸æ­£ç¡®ã€‚
        <ul>
          <li>æè¿°ä½ çš„æ€è€ƒè¿‡ç¨‹â€”â€”ä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ï¼Œå³ä½¿æŸäº›æ­¥éª¤çœ‹èµ·æ¥å¾®ä¸è¶³é“ã€‚</li>
          <li>å¦‚æœä½ åšå‡ºäº†æŸä¸ªå‡è®¾æˆ–çŒœæµ‹ï¼Œè¯·è§£é‡Šä½ ä¸ºä»€ä¹ˆä¼šé‚£æ ·æƒ³ã€‚</li>
          <li>å¦‚æœä½ æ”¹å˜äº†æƒ³æ³•æˆ–æ”¾å¼ƒäº†æŸä¸ªé€‰é¡¹ï¼Œè¯·è¯´æ˜åŸå› ã€‚</li>
        </ul>
      </li>
      <li><strong>æœ€ç»ˆç­”æ¡ˆ</strong>ï¼šåœ¨å®Œæˆæ•´ä¸ªæ€è€ƒè¿‡ç¨‹åï¼Œé€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„é€‰é¡¹ï¼Œå¹¶è§£é‡Šä½ ä¸ºä»€ä¹ˆé€‰æ‹©å®ƒã€‚å¦‚æœä½ ä¸ç¡®å®šï¼Œä¹Ÿè¯·è¯´æ˜ä½ çš„ä¸ç¡®å®šæ€§ã€‚</li>
    </ol>
    <h4>å¥½çš„å›ç­”ç¤ºä¾‹ï¼š</h4>
    <pre>
é—®é¢˜ï¼šâ€œå›å£°æ˜¯ç”±å“ªç§ç±»å‹çš„å£°éŸ³åå°„äº§ç”Ÿçš„ï¼Ÿâ€
Aï¼šç›´æ¥çš„ï¼ˆDirectï¼‰
Bï¼šè¿œå¤„çš„ï¼ˆDistantï¼‰
Cï¼šå˜åŒ–çš„ï¼ˆVariedï¼‰
Dï¼šå•ä¸€çš„ï¼ˆSingleï¼‰

- â€œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºå“ªç§åå°„ç±»å‹ä¼šäº§ç”Ÿå›å£°ï¼Œå¹¶æä¾›äº†å››ä¸ªé€‰é¡¹ã€‚å°†å®ƒä»¬ä¸â€˜åå°„â€™ç»“åˆï¼Œå¯ä»¥å¾—åˆ°â€˜ç›´æ¥åå°„â€™ã€â€˜è¿œè·ç¦»åå°„â€™ã€â€˜å˜åŒ–åå°„â€™å’Œâ€˜å•ä¸€åå°„â€™ã€‚
é¦–å…ˆæˆ‘éœ€è¦å›å¿†ä¸€ä¸‹ä»€ä¹ˆæ˜¯å›å£°ã€‚åœ¨ç‰©ç†è¯¾ä¸Šï¼Œæˆ‘å­¦è¿‡å›å£°æ˜¯ç”±é•œé¢åå°„çš„å£°æ³¢äº§ç”Ÿçš„ã€‚è¿™ç§åå°„å‘ç”Ÿåœ¨å£°æ³¢é‡åˆ°å¤§è€Œå¹³æ»‘ä¸”åšç¡¬çš„è¡¨é¢ï¼ˆæ¯”å¦‚æ‚¬å´–æˆ–å¢™å£ï¼‰æ—¶ï¼Œå£°æ³¢ä¼šæ²¿ä¸€ä¸ªæ–¹å‘æœ‰åºåœ°åå°„å›æ¥ã€‚
è¿™ç§åå°„ä¿ç•™äº†å£°éŸ³çš„ç»“æ„ï¼Œä½¿å®ƒèƒ½ä½œä¸ºåŸå£°çš„æ¸…æ™°é‡å¤å›åˆ°å¬è€…è€³ä¸­ã€‚ä½†â€˜é•œé¢åå°„â€™å¹¶ä¸åœ¨æä¾›çš„é€‰é¡¹ä¸­ã€‚
è®©æˆ‘ç¡®è®¤ä¸€ä¸‹æœ¯è¯­æ˜¯å¦å‡†ç¡®ã€‚åœ¨å£°éŸ³çš„è¯­å¢ƒä¸­ï¼Œæœ‰æ—¶äººä»¬ä¹Ÿç§°å…¶ä¸ºâ€˜ç¡¬åå°„â€™æˆ–â€˜ç›´æ¥åå°„â€™ã€‚æ‰€ä»¥ç­”æ¡ˆå¾ˆæ˜ç¡®ï¼Œæˆ‘åº”è¯¥é€‰æ‹© Aã€‚â€
    </pre>
    <button id="start-btn" onclick="showUserInfo()"></button>
    <button id="clear-btn" onclick="clearCache()"></button>

  </div>

<!-- Step 2: ç”¨æˆ·ä¿¡æ¯ -->
<div id="user-info" class="hidden">
  <label id="gender-label">
    <span id="gender-label-text">æ€§åˆ«ï¼š</span>
    <select id="gender"></select>
  </label>

  <label id="school-label">
    <span id="school-label-text">å­¦æ ¡ï¼š</span>
    <input type="text" id="school">
  </label>

  <label id="degree-label">
    <span id="degree-label-text">å­¦å†ï¼š</span>
    <select id="degree"></select>
  </label>

  <label id="region-label">
    <span id="region-label-text">çœ/ç›´è¾–å¸‚ï¼š</span>
    <input type="text" id="region">
  </label>

  <button id="tipi-btn" onclick="showTipi()">å¡«å†™å¤§äº”äººæ ¼æµ‹è¯•</button>
</div>




<!-- Step 2.5: TIPI æµ‹è¯• -->
<div id="tipi-test" class="hidden">
  <h3 id="tipi-title">TIPI å¤§äº”äººæ ¼æµ‹è¯•</h3>
  <p id="tipi-instruction">è¯·æ ¹æ®ä½ è‡ªå·±çš„æ„Ÿè§‰ï¼Œé€‰æ‹©æ¯ä¸€å¯¹å½¢å®¹è¯åœ¨ä½ èº«ä¸Šçš„é€‚ç”¨ç¨‹åº¦ï¼ˆ1=éå¸¸ä¸åŒæ„ï¼Œ7=éå¸¸åŒæ„ï¼‰</p>
  <div id="tipi-items"></div>
  <button id="tipi-confirm-btn" onclick="confirmTipi()">ç¡®è®¤æäº¤ TIPI æµ‹è¯•</button>
</div>

<!-- Step 3: é€‰æ‹©é¢˜ç›®ç»„ -->
<div id="group-select-section" class="hidden">
  <label id="group-select-label">è¯·é€‰æ‹©é¢˜ç›®ç»„ï¼ˆæ¯ç»„åŒ…å«ä¸åŒçš„é¢˜ç›®ç»„åˆï¼‰ï¼š</label>
  <select id="group-select">
    <!-- é€‰é¡¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
  </select>
  <button id="start-group-btn" onclick="startGroup()">å¼€å§‹æ ‡æ³¨</button>
</div>

<!-- Step 4: é€‰æ‹©æ¨ç†ç±»å‹ -->
<div id="category-select-section" class="hidden">
  <label id="category-select-label">é€‰æ‹©æ¨ç†ç±»å‹ï¼š</label>
  <select id="category-select">
    <option value="">è¯·é€‰æ‹©</option>
    <option value="abduction">Abductionï¼ˆæº¯å› ï¼‰</option>
    <option value="deduction">Deductionï¼ˆæ¼”ç»ï¼‰</option>
    <option value="induction">Inductionï¼ˆå½’çº³ï¼‰</option>
  </select>
  <button id="start-category-btn" onclick="startCategory()">å¼€å§‹æ ‡æ³¨</button>
</div>

<!-- Step 5: æ ‡æ³¨ç•Œé¢ -->
<div id="questionnaire" class="hidden">
  <div id="question-box"></div>

  <label id="is-expert-label">ä½ æ˜¯å¦è¯¥é¢˜ç›®ä¸“ä¸šæ–¹å‘ï¼Ÿ</label>
  <select id="is-expert">
    <option value="">è¯·é€‰æ‹©</option>
    <option value="æ˜¯">æ˜¯</option>
    <option value="å¦">å¦</option>
  </select>

  <label id="use-ai-label">æ˜¯å¦ä½¿ç”¨ AI è¾…åŠ©ï¼Ÿ</label>
  <select id="use-ai">
    <option value="">è¯·é€‰æ‹©</option>
    <option value="æ˜¯">æ˜¯</option>
    <option value="å¦">å¦</option>
  </select>

  <label id="did-search-label">æ˜¯å¦æ£€ç´¢äº†ç›¸å…³çŸ¥è¯†ï¼Ÿ</label>
  <select id="did-search">
    <option value="">è¯·é€‰æ‹©</option>
    <option value="æ˜¯">æ˜¯</option>
    <option value="å¦">å¦</option>
  </select>

  <label id="reasoning-steps-label">æ¨ç†è¿‡ç¨‹ï¼š</label>
  <div id="reasoning-steps-container"></div>
  <button type="button" id="add-step-btn" onclick="addReasoningStep()">â• æ–°å¢æ­¥éª¤</button>

  <label id="final-answer-label">æœ€ç»ˆç­”æ¡ˆï¼š</label>
  <div id="final-answer"></div>

  <br/>
  <button id="go-back-btn" onclick="goBack()">â¬…ï¸ è¿”å›ä¸Šä¸€é¢˜</button>
  <button id="save-next-btn" onclick="saveAndNext()">ä¿å­˜å¹¶è¿›å…¥ä¸‹ä¸€é¢˜</button>
  <button id="download-btn" onclick="downloadResults()">ğŸ“¤ ä¸‹è½½å·²æ ‡æ³¨æ•°æ®</button>
  <button id="switch-group-btn" onclick="switchGroup()">ğŸ” åˆ‡æ¢é¢˜ç›®ç»„</button>
</div>

<!-- å®Œæˆæç¤º -->
<div id="done" class="hidden">
  <h2 id="done-title">æœ¬ç»„é¢˜ç›®å·²æ ‡æ³¨å®Œæˆ ğŸ‰</h2>
  <button id="reset-btn" onclick="reset()">åˆ‡æ¢é¢˜ç›®ç»„</button>
</div>

  <script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyBEY2NQRQoOYupja0VAT-ybcIVn7nDtitk",
      authDomain: "reasoning-survey.firebaseapp.com",
      databaseURL: "https://reasoning-survey-default-rtdb.firebaseio.com",
      projectId: "reasoning-survey",
      storageBucket: "reasoning-survey.appspot.com",
      messagingSenderId: "307395227633",
      appId: "1:307395227633:web:e79e929d0b7bb3e0b8de50"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // å…¨å±€çŠ¶æ€
    let userInfo = {},
        questions = [],
        questionIndex = 0,
        completedMap = {},
        responses = [],
        currentCategory = "";

    const tipiItems = [
      { id:1, text:"æˆ‘å±äºå¤–å‘å‹ã€çˆ±äº¤é™…" },
      { id:2, text:"æˆ‘å±äºå†·é™å‹ã€å®‰é™" },
      { id:3, text:"æˆ‘å–œæ¬¢æœ‰æ¡ç†ã€åšäº‹è®¡åˆ’æ€§å¼º" },
      { id:4, text:"æˆ‘æœ‰äº›æ‡’æƒ°" },
      { id:5, text:"æˆ‘å®¹æ˜“ç´§å¼ " },
      { id:6, text:"æˆ‘æƒ…ç»ªç¨³å®šï¼Œä¸æ˜“å¿ƒçƒ¦" },
      { id:7, text:"æˆ‘æ˜¯æœ‰åˆ›é€ åŠ›ã€æœ‰æƒ³è±¡åŠ›çš„äºº" },
      { id:8, text:"æˆ‘æ˜¯ä¼ ç»Ÿå‹ã€ä¸ä¼šå°è¯•æ–°å¥‡äº‹ç‰©" },
      { id:9, text:"æˆ‘è€ƒè™‘å‘¨åˆ°ã€å…³å¿ƒä»–äºº" },
      { id:10,text:"æˆ‘æœ‰æ—¶å¾ˆè‹›åˆ»" }
    ];

    // UI æµç¨‹
    function showUserInfo() {
      document.getElementById("instructions").classList.add("hidden");
      document.getElementById("user-info").classList.remove("hidden");
    }
    function showTipi() {
      const g = document.getElementById("gender").value.trim();
      const s = document.getElementById("school").value.trim();
      const d = document.getElementById("degree").value.trim();
      const r = document.getElementById("region").value.trim();
      if (!g || !s || !d || !r) {
        return alert(LANG_TEXT[currentLang].alertIncompleteUserInfo);
      }
      userInfo = { gender: g, school: s, degree: d, region: r };
      document.getElementById("user-info").classList.add("hidden");
      document.getElementById("tipi-test").classList.remove("hidden");
      const ctr = document.getElementById("tipi-items");
      ctr.innerHTML = "";
      tipiItems.forEach(({id,text})=>{
        const div = document.createElement("div");
        div.innerHTML = `
          <label>${id}. ${text}</label>
          <select id="tipi-${id}">
            ${[...Array(7)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}
          </select>`;
        ctr.appendChild(div);
      });
    }
    function confirmTipi() {
      const scores = {};
      tipiItems.forEach(({id})=>{
        scores[`item${id}`] = +document.getElementById(`tipi-${id}`).value;
      });
      userInfo.tipi_scores = scores;
      localStorage.setItem("user_info", JSON.stringify(userInfo));
      document.getElementById("tipi-test").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    async function startGroup() {
      const grp = document.getElementById("group-select").value;
      if (!grp) return alert("è¯·é€‰æ‹©é¢˜ç›®ç»„");
      currentCategory = grp;
      loadCompleted();
      try {
        const text = await (await fetch(`10_groups_output/${grp}.jsonl`)).text();
        questions = text.trim().split("\n").map(l=>JSON.parse(l));
      } catch(e) {
        return alert("åŠ è½½å¤±è´¥ï¼š"+e);
      }

      questionIndex = questions.findIndex(q => {
        const qid = q.id || q.index;
        return !completedMap[`${currentCategory}:${qid}`];
      });

      if (questionIndex === -1) {
        document.getElementById("done").classList.remove("hidden");
        return;
      }

      responses = [];
      document.getElementById("group-select-section").classList.add("hidden");
      document.getElementById("done").classList.add("hidden");
      document.getElementById("questionnaire").classList.remove("hidden");
      showQuestion();
      localStorage.setItem("last_group", currentCategory);

    }


    function startCategory() {
      // å¦‚æœä½ è¿˜éœ€è¦æ ¹æ®æ¨ç†ç±»å‹å†è¿‡æ»¤é¢˜ç›®ï¼Œåœ¨è¿™é‡Œå®ç°
      document.getElementById("category-select-section").classList.add("hidden");
      document.getElementById("questionnaire").classList.remove("hidden");
    }

    function showQuestion() {
      const q = questions[questionIndex];
      let html = `
        <div class="question-card">
          <h3 style="margin-bottom: 10px;">é¢˜ç›® ${questionIndex + 1} / ${questions.length}</h3>
      `;

      if (q.context) {
        html += `
          <div class="context-box">
            <strong>ä¸Šä¸‹æ–‡ï¼š</strong><br>${q.context}
          </div>
        `;
      }

      html += `<div style="margin: 10px 0;"><strong>${q.question}</strong></div>`;

      (q.choices || []).forEach(c => {
        const m = c.match(/^\((.)\)\s*(.*)$/);
        if (m) {
          html += `<div style="padding-left: 8px;">${m[1]}ï¼š${m[2]}</div>`;
        }
      });

      html += `</div>`;
      document.getElementById("question-box").innerHTML = html;
      renderFinalAnswerOptions(q.choices);
      initReasoningSteps();
      ["is-expert","use-ai","did-search"].forEach(id=>{
        document.getElementById(id).value="";
      });
    }

    function renderFinalAnswerOptions(choices) {
      const container = document.getElementById("final-answer");
      container.innerHTML = "";
      if (Array.isArray(choices) && choices.length > 0) {
        const sel = document.createElement("select");
        sel.id = "final-answer-select";
        sel.innerHTML = `<option value="">${LANG_TEXT[currentLang].selectPlaceholder}</option>`;
        for (const c of choices) {
          const m = c.match(/^\((.)\)\s*(.*)$/);
          if (m) sel.innerHTML += `<option value="${m[1]}">${m[1]}: ${m[2]}</option>`;
        }
        sel.innerHTML += `<option value="${LANG_TEXT[currentLang].uncertainOption}">${LANG_TEXT[currentLang].uncertainOption}</option>`;
        container.appendChild(sel);
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.id = "final-answer-text";
        input.placeholder = "è¯·è¾“å…¥ä½ çš„æœ€ç»ˆç­”æ¡ˆï¼ˆéé€‰æ‹©é¢˜ï¼‰";
        container.appendChild(input);
      }
    }

    function saveAndNext() {
      const q = questions[questionIndex];
      const qid = q.id || q.index;
      if (!qid) return alert("é¢˜ç›®ç¼ºå°‘å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆidæˆ–indexï¼‰");

      const steps = collectSteps();
      const sel = document.getElementById("final-answer-select");
      const txt = document.getElementById("final-answer-text");
      const ans = sel ? sel.value : (txt ? txt.value.trim() : "");
      const exp = document.getElementById("is-expert").value;
      const ai = document.getElementById("use-ai").value;
      const ds = document.getElementById("did-search").value;
      if (!exp||!ai||!ds||!ans||!steps.length) {
        return alert("è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å­—æ®µ");
      }
      const entry = {
        user_info: userInfo,
        id: qid,
        source_group: currentCategory,
        question: q.question,
        options: q.choices,
        user_is_expert: exp,
        used_ai: ai,
        did_search: ds,
        reasoning_steps: steps,
        final_answer: ans
      };
      responses = responses.filter(r=>r.id!==q.id).concat(entry);
      markDone(qid);
      saveLocal(entry);
      saveToFirebase(entry);
      questionIndex++;
      if (questionIndex>=questions.length) {
        document.getElementById("questionnaire").classList.add("hidden");
        document.getElementById("done").classList.remove("hidden");
      } else {
        showQuestion();
      }
    }


    function goBack() {
      if (questionIndex===0) return alert("å·²ç»æ˜¯ç¬¬ä¸€é¢˜");
      questionIndex--;
      showQuestion();
    }

    function switchGroup() {
      if (!confirm("ç¡®å®šåˆ‡æ¢é¢˜ç›®ç»„ï¼Ÿ")) return;
      document.getElementById("questionnaire").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    function reset() {
      document.getElementById("done").classList.add("hidden");
      document.getElementById("group-select-section").classList.remove("hidden");
    }

    // è¾…åŠ©ï¼šæ¨ç†æ­¥éª¤
    function initReasoningSteps() {
      const ctr = document.getElementById("reasoning-steps-container");
      ctr.innerHTML = "";
      addReasoningStep();
    }
    function addReasoningStep(txt="") {
      const ctr = document.getElementById("reasoning-steps-container");
      const idx = ctr.children.length + 1;
      const div = document.createElement("div");
      div.innerHTML = `
        <label>${LANG_TEXT[currentLang].reasoningStepLabel} ${idx}</label>
        <textarea>${txt}</textarea>
        <button type="button" onclick="this.parentNode.remove(),initReasoningSteps()">${LANG_TEXT[currentLang].deleteStep}</button>
      `;

      ctr.appendChild(div);
    }
    function collectSteps() {
      return Array.from(document.querySelectorAll("#reasoning-steps-container textarea"))
        .map(t=>t.value.trim()).filter(v=>v);
    }

    // æœ¬åœ°å­˜å‚¨
    function loadCompleted() {
      completedMap = JSON.parse(localStorage.getItem("completed_ids")||"{}");
    }
    function markDone(id) {
      completedMap[`${currentCategory}:${id}`] = true;
      localStorage.setItem("completed_ids", JSON.stringify(completedMap));
    }

    function saveLocal(entry) {
      const arr = JSON.parse(localStorage.getItem("responses")||"[]");
      arr.push(entry);
      localStorage.setItem("responses", JSON.stringify(arr));
    }

    // Firebase å­˜å‚¨
    function saveToFirebase(entry) {
      database.ref("responses/" + Date.now()).set(entry)
        .catch(console.error);
    }

    // ä¸‹è½½
    function downloadResults() {
      const data = localStorage.getItem("responses");
      if (!data) return alert("æ— æ ‡æ³¨ç»“æœ");
      const u = JSON.parse(localStorage.getItem("user_info")||"{}");
      const fn = `annotated_${u.gender||"u"}_${u.school||"u"}_${u.degree||"u"}_${u.region||"u"}_${new Date().toISOString().slice(0,10)}.json`;
      const b = new Blob([data], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download = fn;
      a.click();
    }

    function clearCache() {
      if (confirm("âš ï¸ ç¡®å®šæ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼Ÿ")) {
        localStorage.clear();
        location.reload();
      }
    }
    function populateGroupOptions(maxGroup = 20) {
      const select = document.getElementById("group-select");
      select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';  // åˆå§‹åŒ–
      for (let i = 1; i <= maxGroup; i++) {
        const val = `group_${i}`;
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = `ç¬¬${i}ç»„`;
        select.appendChild(opt);
      }
    }


window.onload = () => {
  // æ¢å¤ç”¨æˆ·ä¿¡æ¯
  const u = localStorage.getItem("user_info");
  if (u) userInfo = JSON.parse(u);

  // åˆå§‹åŒ–è¯­è¨€æ¸²æŸ“
  renderLang();

  
  populateGroupOptions(210);  

  // å°è¯•æ¢å¤ä¸Šæ¬¡çŠ¶æ€
  const lastGroup = localStorage.getItem("last_group");
  if (lastGroup) {
    currentCategory = lastGroup;
    loadCompleted();
    fetch(`10_groups_output/${currentCategory}.jsonl`)
      .then(r => r.text())
      .then(text => {
        questions = text.trim().split("\n").map(l => JSON.parse(l));
        questionIndex = questions.findIndex(q => {
          const qid = q.id || q.index;
          return !completedMap[`${currentCategory}:${qid}`];
        });

        if (questionIndex === -1) {
          document.getElementById("done").classList.remove("hidden");
        } else {
          document.getElementById("instructions").classList.add("hidden");
          document.getElementById("questionnaire").classList.remove("hidden");
          showQuestion();
        }
      })
      .catch(e => console.error("æ¢å¤é¢˜ç›®å¤±è´¥", e));
  }
};


    let currentLang = localStorage.getItem("current_lang") || "zh";

    const LANG_TEXT = {
  zh: {
    langBtn: "English",
    instructionsTitle: "æ¨ç†é—®å·æ ‡æ³¨ç³»ç»Ÿ",
    instructionsContent: `
1. <strong>é—®é¢˜</strong>ï¼šè®¤çœŸé˜…è¯»é¢˜ç›®ï¼Œä»”ç»†æ€è€ƒæ‰€ç»™é€‰é¡¹ã€‚
2. <strong>æ¨ç†è¿‡ç¨‹</strong>ï¼šä»ä½ æœ€åˆè®¤ä¸ºå¯èƒ½æ­£ç¡®çš„ç­”æ¡ˆå¼€å§‹è§£é‡Šï¼Œè€ƒè™‘ä¸ºä»€ä¹ˆæŸäº›é€‰é¡¹å¯èƒ½æ­£ç¡®æˆ–ä¸æ­£ç¡®ã€‚
  - æè¿°ä½ çš„æ€è€ƒè¿‡ç¨‹ï¼Œä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ï¼Œå³ä½¿çœ‹ä¼¼å¾®ä¸è¶³é“ã€‚
  - å¦‚æœåšå‡ºå‡è®¾æˆ–çŒœæµ‹ï¼Œè¯·è§£é‡ŠåŸå› ã€‚å¦‚æœæ”¹å˜ä¸»æ„æˆ–æ”¾å¼ƒæŸé€‰é¡¹ï¼Œè¯·è¯´æ˜ç†ç”±ã€‚
3. <strong>æœ€ç»ˆç­”æ¡ˆ</strong>ï¼šåœ¨å®Œæˆæ•´ä¸ªæ€è€ƒè¿‡ç¨‹åï¼Œé€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„é€‰é¡¹ï¼Œå¹¶è§£é‡ŠåŸå› ã€‚å¦‚æœä¸ç¡®å®šï¼Œè¯·è¯´æ˜ä¸ç¡®å®šæ€§ã€‚
    `,
    exampleTitle: "å¥½çš„å›ç­”ç¤ºä¾‹ï¼š",
    exampleContent: `
é—®é¢˜ï¼šâ€œå›å£°æ˜¯ç”±å“ªç§ç±»å‹çš„å£°éŸ³åå°„äº§ç”Ÿçš„ï¼Ÿâ€
Aï¼šç›´æ¥çš„ï¼ˆDirectï¼‰
Bï¼šè¿œå¤„çš„ï¼ˆDistantï¼‰
Cï¼šå˜åŒ–çš„ï¼ˆVariedï¼‰
Dï¼šå•ä¸€çš„ï¼ˆSingleï¼‰

- â€œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºå“ªç§åå°„ç±»å‹ä¼šäº§ç”Ÿå›å£°ï¼Œå¹¶æä¾›äº†å››ä¸ªé€‰é¡¹ã€‚å°†å®ƒä»¬ä¸â€˜åå°„â€™ç»“åˆï¼Œå¯ä»¥å¾—åˆ°â€˜ç›´æ¥åå°„â€™ã€â€˜è¿œè·ç¦»åå°„â€™ã€â€˜å˜åŒ–åå°„â€™å’Œâ€˜å•ä¸€åå°„â€™ã€‚
é¦–å…ˆæˆ‘éœ€è¦å›å¿†ä¸€ä¸‹ä»€ä¹ˆæ˜¯å›å£°ã€‚åœ¨ç‰©ç†è¯¾ä¸Šï¼Œæˆ‘å­¦è¿‡å›å£°æ˜¯ç”±é•œé¢åå°„çš„å£°æ³¢äº§ç”Ÿçš„ã€‚è¿™ç§åå°„å‘ç”Ÿåœ¨å£°æ³¢é‡åˆ°å¤§è€Œå¹³æ»‘ä¸”åšç¡¬çš„è¡¨é¢ï¼ˆæ¯”å¦‚æ‚¬å´–æˆ–å¢™å£ï¼‰æ—¶ï¼Œå£°æ³¢ä¼šæ²¿ä¸€ä¸ªæ–¹å‘æœ‰åºåœ°åå°„å›æ¥ã€‚è¿™ç§åå°„ä¿ç•™äº†å£°éŸ³çš„ç»“æ„ï¼Œä½¿å®ƒèƒ½ä½œä¸ºåŸå£°çš„æ¸…æ™°é‡å¤å›åˆ°å¬è€…è€³ä¸­ã€‚ä½†â€˜é•œé¢åå°„â€™å¹¶ä¸åœ¨æä¾›çš„é€‰é¡¹ä¸­ã€‚
è®©æˆ‘ç¡®è®¤ä¸€ä¸‹æœ¯è¯­æ˜¯å¦å‡†ç¡®ã€‚åœ¨å£°éŸ³çš„è¯­å¢ƒä¸­ï¼Œæœ‰æ—¶äººä»¬ä¹Ÿç§°å…¶ä¸ºâ€˜ç¡¬åå°„â€™æˆ–â€˜ç›´æ¥åå°„â€™ã€‚æ‰€ä»¥ç­”æ¡ˆå¾ˆæ˜ç¡®ï¼Œæˆ‘åº”è¯¥é€‰æ‹© Aã€‚â€
    `,
    genderLabel: "æ€§åˆ«ï¼š",
    schoolLabel: "å­¦æ ¡ï¼š",
    degreeLabel: "å­¦å†ï¼š",
    regionLabel: "çœ/ç›´è¾–å¸‚ï¼š",
    degreeOptions: ["è¯·é€‰æ‹©", "æœ¬ç§‘", "ç¡•å£«", "åšå£«", "å…¶ä»–"],
    genderOptions: ["è¯·é€‰æ‹©", "ç”·", "å¥³", "å…¶ä»–"],
    groupSelectLabel: "è¯·é€‰æ‹©é¢˜ç›®ç»„ï¼ˆæ¯ç»„åŒ…å«ä¸åŒçš„é¢˜ç›®ç»„åˆï¼‰ï¼š",
    categorySelectLabel: "é€‰æ‹©æ¨ç†ç±»å‹ï¼š",
    reasoningStepsLabel: "æ¨ç†è¿‡ç¨‹ï¼š",
    finalAnswerLabel: "æœ€ç»ˆç­”æ¡ˆï¼š",
    isExpertLabel: "ä½ æ˜¯å¦è¯¥é¢˜ç›®ä¸“ä¸šæ–¹å‘ï¼Ÿ",
    useAiLabel: "æ˜¯å¦ä½¿ç”¨ AI è¾…åŠ©ï¼Ÿ",
    didSearchLabel: "æ˜¯å¦æ£€ç´¢äº†ç›¸å…³çŸ¥è¯†ï¼Ÿ",
    selectPlaceholder: "è¯·é€‰æ‹©",
    uncertainOption: "ä¸ç¡®å®š",
    saveAndNext: "ä¿å­˜å¹¶è¿›å…¥ä¸‹ä¸€é¢˜",
    goBack: "â¬…ï¸ è¿”å›ä¸Šä¸€é¢˜",
    switchGroup: "ğŸ” åˆ‡æ¢é¢˜ç›®ç»„",
    download: "ğŸ“¤ ä¸‹è½½å·²æ ‡æ³¨æ•°æ®",
    clearCache: "ğŸ§¹ æ¸…é™¤ç¼“å­˜æ•°æ®",
    tipiItems: [
      "æˆ‘å±äºå¤–å‘å‹ã€çˆ±äº¤é™…",
      "æˆ‘å±äºå†·é™å‹ã€å®‰é™",
      "æˆ‘å–œæ¬¢æœ‰æ¡ç†ã€åšäº‹è®¡åˆ’æ€§å¼º",
      "æˆ‘æœ‰äº›æ‡’æƒ°",
      "æˆ‘å®¹æ˜“ç´§å¼ ",
      "æˆ‘æƒ…ç»ªç¨³å®šï¼Œä¸æ˜“å¿ƒçƒ¦",
      "æˆ‘æ˜¯æœ‰åˆ›é€ åŠ›ã€æœ‰æƒ³è±¡åŠ›çš„äºº",
      "æˆ‘æ˜¯ä¼ ç»Ÿå‹ã€ä¸ä¼šå°è¯•æ–°å¥‡äº‹ç‰©",
      "æˆ‘è€ƒè™‘å‘¨åˆ°ã€å…³å¿ƒä»–äºº",
      "æˆ‘æœ‰æ—¶å¾ˆè‹›åˆ»"
    ],
    tipiBtn: "å¡«å†™å¤§äº”äººæ ¼æµ‹è¯•",
    tipiTitle: "TIPI å¤§äº”äººæ ¼æµ‹è¯•",
    tipiInstruction: "è¯·æ ¹æ®ä½ è‡ªå·±çš„æ„Ÿè§‰ï¼Œé€‰æ‹©æ¯ä¸€å¯¹å½¢å®¹è¯åœ¨ä½ èº«ä¸Šçš„é€‚ç”¨ç¨‹åº¦ï¼ˆ1=éå¸¸ä¸åŒæ„ï¼Œ7=éå¸¸åŒæ„ï¼‰",
    tipiConfirm: "ç¡®è®¤æäº¤ TIPI æµ‹è¯•",
    startFilling: "æˆ‘å·²é˜…è¯»è¯´æ˜ï¼Œå¼€å§‹å¡«å†™",
    startGroup: "å¼€å§‹æ ‡æ³¨",
    startCategory: "å¼€å§‹æ ‡æ³¨",
    addStep: "â• æ–°å¢æ­¥éª¤",
    doneTitle: "æœ¬ç»„é¢˜ç›®å·²æ ‡æ³¨å®Œæˆ ğŸ‰",
    reset: "åˆ‡æ¢é¢˜ç›®ç»„",
    reasoningStepLabel: "æ¨ç†æ­¥éª¤",
    deleteStep: "åˆ é™¤è¯¥æ­¥éª¤",
    alertIncompleteUserInfo: "è¯·å®Œæ•´å¡«å†™ç”¨æˆ·ä¿¡æ¯",


  },
  en: {
    langBtn: "ä¸­æ–‡",
    instructionsTitle: "Reasoning Questionnaire Annotation System",
    instructionsContent: `
1. <strong>Question</strong>: Read the question carefully. Think about the options provided.
2. <strong>Reasoning</strong>: Begin by explaining what you initially think the answer could be. Consider why certain options might or might not be correct.
  - Describe your thought processâ€”do not skip any steps, even if they seem insignificant.
  - If you make an assumption or guess, explain why you made that choice. If you change your mind or discard an option, clarify why that happened.
3. <strong>Final Answer</strong>: After completing your thought process, choose the option you believe to be correct, and explain why you selected it. If you're unsure, please indicate your uncertainty.
    `,
    exampleTitle: "Example of a good response:",
    exampleContent: `
question:"An echo is produced by what type of reflection of sound source?"
A:Direct
B:Distant
C:Varied
D:Single

- "The question is about what kind of reflection produce an echo, and four options are provided. Combining them with 'reflection', we have 'Direct reflection', 'Distant reflection','Varied reflection' and 'Single reflection'. First I need to recall what is an echo. In physics classes, I was taught that an echo is produced by 'specular reflection' of sound waves. This type of reflection occurs when sound waves encounter a large, smooth, and rigid surface, such as a cliff or a wall, causing the waves to reflect coherently in a single direction. This preserves the sound's structure and allows it to return to the listener as a distinct repetition of the original sound. But 'specular reflection' does not exist in the options provided. Let me check if the terminology is correct. In the context of sound, sometimes people refer to it as a 'hard reflection' or 'direct reflection'. So the answer is clear, I should choose A."
    `,
    genderLabel: "Gender:",
    schoolLabel: "School:",
    degreeLabel: "Degree:",
    regionLabel: "Province/City:",
    degreeOptions: ["Please select", "Undergraduate", "Master", "PhD", "Other"],
    genderOptions: ["Please select", "Male", "Female", "Other"],
    groupSelectLabel: "Please select a question group (each contains a different question mix):",
    categorySelectLabel: "Select reasoning type:",
    reasoningStepsLabel: "Reasoning process:",
    finalAnswerLabel: "Final answer:",
    isExpertLabel: "Are you an expert in this topic?",
    useAiLabel: "Did you use AI assistance?",
    didSearchLabel: "Did you search for related knowledge?",
    selectPlaceholder: "Please select",
    uncertainOption: "Uncertain",
    saveAndNext: "Save and Next",
    goBack: "â¬…ï¸ Previous question",
    switchGroup: "ğŸ” Switch group",
    download: "ğŸ“¤ Download annotations",
    clearCache: "ğŸ§¹ Clear cached data",
    tipiItems: [
      "I am extroverted, sociable",
      "I am reserved, quiet",
      "I am dependable, self-disciplined",
      "I am disorganized, careless",
      "I am anxious, easily upset",
      "I am calm, emotionally stable",
      "I am open to new experiences, complex",
      "I am conventional, uncreative",
      "I am sympathetic, warm",
      "I am critical, quarrelsome"
    ],
    tipiBtn: "Fill in TIPI test",
    tipiTitle: "TIPI Big Five Personality Test",
    tipiInstruction: "Please select how well each pair of traits applies to you (1 = strongly disagree, 7 = strongly agree)",
    tipiConfirm: "Submit TIPI test",
    startFilling: "I have read the instructions, start filling",
    startGroup: "Start annotation",
    startCategory: "Start annotation",
    addStep: "â• Add step",
    doneTitle: "Group completed ğŸ‰",
    reset: "Switch group",
    reasoningStepLabel: "Reasoning Step",
    deleteStep: "Delete Step",
    alertIncompleteUserInfo: "Please complete all user info fields",


  }
};

    function renderLang() {
      const text = LANG_TEXT[currentLang];

      // é¡µé¢ä¸»æ ‡é¢˜
      document.querySelector("h1").textContent = text.instructionsTitle;
      document.getElementById("main-title").textContent = text.instructionsTitle;
      document.getElementById("instructions-title").textContent = text.instructionsTitle;
      document.getElementById("start-btn").textContent = text.startFilling;
      document.getElementById("clear-btn").textContent = text.clearCache;

      // è¯´æ˜åŒºåŸŸ
      document.querySelector("#instructions h3").textContent = text.instructionsTitle;
      document.querySelector("#instructions ol").innerHTML = text.instructionsContent;
      document.querySelector("#instructions pre").textContent = text.exampleContent;
      document.querySelector("#instructions h4").textContent = text.exampleTitle;
      document.querySelector("#instructions button[onclick='showUserInfo()']").textContent = text.startFilling;
      document.querySelector("#instructions button[onclick='clearCache()']").textContent = text.clearCache;

      // ç”¨æˆ·ä¿¡æ¯è¡¨å•
      document.getElementById("gender-label-text").textContent = text.genderLabel;
      document.getElementById("school-label-text").textContent = text.schoolLabel;
      document.getElementById("degree-label-text").textContent = text.degreeLabel;
      document.getElementById("region-label-text").textContent = text.regionLabel;

      document.getElementById("tipi-btn").textContent = text.tipiBtn;

      // æ€§åˆ«é€‰é¡¹
      const genderSel = document.getElementById("gender");
      genderSel.innerHTML = text.genderOptions.map(opt => `<option value="${opt}">${opt}</option>`).join("");

      const degreeSel = document.getElementById("degree");
      degreeSel.innerHTML = text.degreeOptions.map(opt => `<option value="${opt}">${opt}</option>`).join("");



      // TIPI éƒ¨åˆ†
      document.getElementById("tipi-title").textContent = text.tipiTitle;
      document.getElementById("tipi-instruction").textContent = text.tipiInstruction;
      document.getElementById("tipi-confirm-btn").textContent = text.tipiConfirm;
      const tipiCtr = document.getElementById("tipi-items");
      tipiCtr.innerHTML = "";
      text.tipiItems.forEach((t, idx) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <label>${idx + 1}. ${t}</label>
          <select id="tipi-${idx + 1}">
            ${[...Array(7)].map((_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("")}
          </select>`;
        tipiCtr.appendChild(div);
      });

      // é¢˜ç›®ç»„é€‰æ‹©
      document.getElementById("group-select-label").textContent = text.groupSelectLabel;
      document.getElementById("start-group-btn").textContent = text.startGroup;

      // æ¨ç†ç±»å‹
      document.getElementById("category-select-label").textContent = text.categorySelectLabel;
      document.getElementById("start-category-btn").textContent = text.startCategory;

      // æ ‡æ³¨è¡¨å•
      document.getElementById("is-expert-label").textContent = text.isExpertLabel;
      document.getElementById("use-ai-label").textContent = text.useAiLabel;
      document.getElementById("did-search-label").textContent = text.didSearchLabel;
      document.getElementById("reasoning-steps-label").textContent = text.reasoningStepsLabel;
      document.getElementById("final-answer-label").textContent = text.finalAnswerLabel;
      document.getElementById("add-step-btn").textContent = text.addStep;

      // æ ‡æ³¨è¡¨å•æŒ‰é’®
      document.getElementById("go-back-btn").textContent = text.goBack;
      document.getElementById("save-next-btn").textContent = text.saveAndNext;
      document.getElementById("download-btn").textContent = text.download;
      document.getElementById("switch-group-btn").textContent = text.switchGroup;

      // å®Œæˆæç¤º
      document.getElementById("done-title").textContent = text.doneTitle;
      document.getElementById("reset-btn").textContent = text.reset;

      // åˆ‡æ¢æŒ‰é’®
      document.getElementById("lang-btn-text").textContent = text.langBtn;
    }


    function switchLanguage() {
      currentLang = currentLang === "zh" ? "en" : "zh";
      localStorage.setItem("current_lang", currentLang);
      renderLang();
    }




  </script>
  </div>

</body>
</html>
